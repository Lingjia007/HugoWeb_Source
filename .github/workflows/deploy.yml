name: Deploy to GitHub Pages and Netlify

on:
  push:
    branches:
      - main

jobs:
  # 作业1：部署到 GitHub Pages
  deploy-to-gh-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Set up Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "latest"

      - name: Build Hugo site
        run: hugo -F --cleanDestinationDir

      # 以下复制步骤若确有必要，保留；否则建议移除
      - name: Copy static and assets (Optional)
        run: |
          mkdir -p en zh-hk
          cp -r static/* en/
          cp -r static/* zh-hk/
          cp -r assets/* en/
          cp -r assets/* zh-hk/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          PERSONAL_TOKEN: ${{ secrets.TOKEN }}
          EXTERNAL_REPOSITORY: Lingjia007/Hugo_Web
          PUBLISH_BRANCH: master
          PUBLISH_DIR: ./public
          commit_message: ${{ github.event.head_commit.message }}

  # 作业2：部署到 Netlify
  deploy-to-netlify:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Switch to netlify branch
        run: git checkout -B netlify

      # 确保 hugo.yaml 路径正确
      - name: Modify hugo.yaml for Netlify
        run: |
          sed -i '1s#https://lingjia007.github.io/Hugo_Web/#https://lingsir007.netlify.app/#' hugo.yaml

      - name: Set up Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "latest"

      - name: Build Hugo site for Netlify
        run: hugo -F --cleanDestinationDir

      # 合并复制步骤，若非必要则移除
      - name: Copy static and assets (Optional)
        run: |
          mkdir -p en zh-hk
          cp -r static/* en/
          cp -r static/* zh-hk/
          cp -r assets/* en/
          cp -r assets/* zh-hk/

      - name: Push to Netlify branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          PERSONAL_TOKEN: ${{ secrets.TOKEN }}
          EXTERNAL_REPOSITORY: Lingjia007/Hugo_Web
          PUBLISH_BRANCH: netlify
          PUBLISH_DIR: ./public  # 确保推送构建后的 public 目录
          commit_message: "Deploy to Netlify: ${{ github.sha }}"
